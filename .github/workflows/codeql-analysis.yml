name: "CodeQL Analysis"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 2 * * 0'  # weekly scan

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]  # covers both JS and TS

    steps:
      # ---------------------------------------------------------
      # Checkout source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Initialize CodeQL
      # ---------------------------------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality  # full rule set

      # ---------------------------------------------------------
      # Attempt autobuild (for TS/JS usually succeeds)
      # ---------------------------------------------------------
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      # ---------------------------------------------------------
      # Run CodeQL Analysis
      # ---------------------------------------------------------
      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@v4
        with:
          output: results

      # ---------------------------------------------------------
      # Prepare report directory
      # ---------------------------------------------------------
      - name: Prepare reports directory
        run: mkdir -p reports

      # ---------------------------------------------------------
      # Export CSV from SARIF using jq
      # ---------------------------------------------------------
      - name: Export CSV from SARIF
        shell: bash
        run: |
          FILE="results/javascript.sarif"
          if [ ! -f "$FILE" ]; then
            echo "SARIF not found at $FILE"; exit 1
          fi
          echo "ruleId,level,message,file,line" > reports/codeql-report.csv
          jq -r '
            .runs[]
            | .results[]
            | [
                (.ruleId // ""),
                (.level // (.properties.severity // "note")),
                (.message.text // "" | gsub("[\\r\\n]+"; " ") | gsub("\""; "\"\"")),
                (.locations[0].physicalLocation.artifactLocation.uri // ""),
                (.locations[0].physicalLocation.region.startLine // 0)
              ]
            | @csv
          ' "$FILE" >> reports/codeql-report.csv

      # ---------------------------------------------------------
      # Summarize results directly in GitHub UI
      # ---------------------------------------------------------
      - name: Write CodeQL Summary
        shell: bash
        run: |
          FILE="results/javascript.sarif"
          echo "# ðŸ§  CodeQL Scan Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # --- Overall counts by severity ---
          jq -r '
            def lvl:
              if has("level") then .level
              elif (.properties | type=="object") and (.properties.severity? != null)
                then (.properties.severity | ascii_downcase)
              else "note" end;
            [ .runs[].results[] | lvl ] as $lvls |
            "Total Findings: \($lvls|length)" + "\n" +
            "Errors: \($lvls|map(select(.==\"error\"))|length)" + "\n" +
            "Warnings: \($lvls|map(select(.==\"warning\"))|length)" + "\n" +
            "Notes: \($lvls|map(select(.==\"note\"))|length)"
          ' "$FILE" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ” Top Rule IDs" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          jq -r '
            .runs[].results[].ruleId
            | select(. != null)
          ' "$FILE" | sort | uniq -c | sort -rn | head -15 \
            | awk '{printf "- **%s** â€” %s findings\n", $2, $1}' >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> ðŸ“ Full SARIF and CSV reports are available as workflow artifacts." >> "$GITHUB_STEP_SUMMARY"

      # ---------------------------------------------------------
      # Upload SARIF + CSV for manual inspection
      # ---------------------------------------------------------
      - name: Upload CodeQL Reports
        uses: actions/upload-artifact@v4
        with:
          name: codeql-analysis-reports
          path: |
            results/
            reports/
